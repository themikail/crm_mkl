rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isMklDomain() {
      return isSignedIn() && request.auth.token.email.endsWith('@groupmkl.com');
    }

    function getMembership(orgId) {
      return get(/databases/$(database)/documents/orgs/$(orgId)/members/$(request.auth.uid));
    }
    
    function isOrgMember(orgId) {
      return isMklDomain() && exists(/databases/$(database)/documents/orgs/$(orgId)/members/$(request.auth.uid));
    }
    
    function isOrgAdmin(orgId) {
      let role = getMembership(orgId).data.role;
      return isOrgMember(orgId) && (role == 'admin' || role == 'owner');
    }

    function isOrgOwner(orgId) {
      let role = getMembership(orgId).data.role;
      return isOrgMember(orgId) && role == 'owner';
    }

    // Rules
    
    // Users collection is not used for authorization, so deny all reads/writes.
    // User profile data should be stored within the org's members collection.
    match /users/{userId} {
      allow read, write: if false;
    }

    // Lock down the entire `orgs` collection by default.
    match /orgs/{orgId} {
        // Only allow access to the 'groupmkl' organization
        allow read, write: if orgId == 'groupmkl' && isMklDomain();

        // Members can read the org doc, admins can update it.
        allow get: if isOrgMember(orgId);
        allow update: if isOrgAdmin(orgId);
        // Org creation/deletion is handled by a secure backend function.
        allow create, delete: if false; 

        // Integrations: Members can read, admins can update.
        match /integrations/google {
          allow get: if isOrgMember(orgId);
          allow create, update: if isOrgAdmin(orgId);
          allow delete: if false;
        }

        // Members:
        // Admins can manage all members.
        // Users can read their own membership.
        // Creation is handled by a secure backend function.
        match /members/{userId} {
          allow get: if request.auth.uid == userId || isOrgAdmin(orgId);
          allow list: if isOrgAdmin(orgId);
          allow update: if isOrgAdmin(orgId);
          // Only admins can delete, and they cannot delete the owner.
          allow delete: if isOrgAdmin(orgId) && resource.data.role != 'owner';
          allow create: if false; // Creation handled by cloud function
        }
        
        // Generic rule for all other subcollections (companies, contacts, deals, etc.)
        // Any member of the org can perform CRUD operations.
        match /{collection}/{docId} {
          allow read, list, create, update, delete: if isOrgMember(orgId);
        }
    }
  }
}
