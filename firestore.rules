rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function getMembership(orgId) {
      return get(/databases/$(database)/documents/orgs/$(orgId)/members/$(request.auth.uid));
    }
    
    function isOrgMember(orgId) {
      return exists(/databases/$(database)/documents/orgs/$(orgId)/members/$(request.auth.uid));
    }
    
    function isOrgAdmin(orgId) {
      let role = getMembership(orgId).data.role;
      return isOrgMember(orgId) && (role == 'admin' || role == 'owner');
    }

    function isOrgOwner(orgId) {
      let role = getMembership(orgId).data.role;
      return isOrgMember(orgId) && role == 'owner';
    }

    function hasValidOrgIdOnCreate(orgId) {
      return request.resource.data.orgId == orgId;
    }

    function isOrgIdImmutable() {
      return request.resource.data.orgId == resource.data.orgId;
    }
    
    // User Profiles: Users can manage their own profile.
    match /users/{userId} {
      allow read, update, delete: if isOwner(userId);
      allow create: if isSignedIn();
    }

    // Organizations: Org creation is handled by backend logic.
    // Members can read the org doc, admins can update it.
    match /orgs/{orgId} {
      allow get: if isOrgMember(orgId);
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isOrgAdmin(orgId);
      allow delete: if false; // Deleting orgs should be a backend process

      // Members: Users can read their own membership, admins can manage all members.
      match /members/{userId} {
        allow get: if isOwner(userId) || isOrgAdmin(orgId);
        allow list: if isOrgAdmin(orgId);
        allow create, update: if isOrgAdmin(orgId);
        allow delete: if isOrgAdmin(orgId) && isOwner(userId) == false; // Prevent owner from being removed by other admins
      }
      
      // Integrations: Members can read, admins can update.
      match /integrations/google {
        allow get: if isOrgMember(orgId);
        allow create, update: if isOrgAdmin(orgId);
        allow delete: if false;
      }
      
      // Generic rule for all other subcollections (companies, contacts, etc.)
      // Any member of the org can perform CRUD operations.
      match /{collection}/{docId} {
        allow read, list: if isOrgMember(orgId);
        allow create: if isOrgMember(orgId) && hasValidOrgIdOnCreate(orgId);
        allow update: if isOrgMember(orgId) && isOrgIdImmutable();
        allow delete: if isOrgMember(orgId);
      }
    }
  }
}

    